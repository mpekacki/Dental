<apex:page controller="AccountRemoter" showHeader="false" standardStyleSheets="false">
	<apex:includeScript value="{! URLFOR($Resource.jQuery224)}"/>
	<apex:includeScript value="{! URLFOR($Resource.jQueryUI, '/jquery-ui-1.11.4.custom/jquery-ui.min.js')}"/>
	<apex:stylesheet value="{! URLFOR($Resource.jQueryUI, '/jquery-ui-1.11.4.custom/jquery-ui.min.css')}"/>

	<apex:includeScript value="{! URLFOR($Resource.Bootstrap, '/bootstrap-3.3.6-dist/js/bootstrap.min.js')}"/>
	<apex:stylesheet value="{! URLFOR($Resource.Bootstrap, 'bootstrap-3.3.6-dist/css/bootstrap.min.css')}"/>

	<apex:includeScript value="{! URLFOR($Resource.BootstrapDatepicker, '/js/bootstrap-datetimepicker.min.js')}"/>
	<apex:stylesheet value="{! URLFOR($Resource.BootstrapDatepicker, '/css/bootstrap-datetimepicker.min.css')}"/>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css"></link>



	<script> 
		"use strict";
		
		var availableDates = [];
		var selectedDentistID;
		var selectedTime;
		
		function getDentists(callback) {
			Visualforce.remoting.Manager.invokeAction(
				'{!$RemoteAction.AccountRemoter.getDentists}',
				callback,
				{buffer: false}
			);
		}
		
		function getDates(dentistId, callback) {
			Visualforce.remoting.Manager.invokeAction(
				'{!$RemoteAction.AccountRemoter.getAvailableDatesForDentist}',
				dentistId,
				callback,
				{buffer: false}
			);
		}
		
		function getTimes(dentistId, date, callback) {
			Visualforce.remoting.Manager.invokeAction(
				'{!$RemoteAction.AccountRemoter.getAvailableTimesForDentistAndDate}',
				dentistId,
				date,
				callback,
				{buffer: false}
			);
		}

		function getReservedSlot(token, callback) {
			Visualforce.remoting.Manager.invokeAction(
				'{!$RemoteAction.AccountRemoter.getReservedSlot}',
				token,
				callback,
				{buffer: false}
			);
		}
		
		function reserveTimeSlot(token, dentistId, dateTime, callback) {
			Visualforce.remoting.Manager.invokeAction(
				'{!$RemoteAction.AccountRemoter.reserveTimeSlot}',
				token,
				dentistId,
				dateTime,
				callback,
				{buffer: false}
			);
		}
		
		function registerAppointment(token, dentistId, dateTime, description, type, firstName, lastName, phone, email, callback) {
			Visualforce.remoting.Manager.invokeAction(
				'{!$RemoteAction.AccountRemoter.registerAppointment}',
				token,
				dentistId,
				dateTime,
				description, 
				type, 
				firstName, 
				lastName, 
				phone, 
				email,
				callback,
				{buffer: false}
			);
		}
		
		function submitDetails(event) {
			
			registerAppointment(
				sessionStorage.token,
				$('input[type=radio][name=dentist]:checked').val(), 
				$('input[type=radio][name=time]:checked').val(),
				$('textarea[name=description]').val(),
				$('input[name=type]:checked').val(),
				$('input[name=firstname]').val(),
				$('input[name=lastname]').val(),
				$('input[name=phone]').val(),
				$('input[name=email]').val(),
				function(result, event) {
					if(event.status){
						$('.container').html('<div class="alert alert-success">Your appointment has been registered and submitted for approval. You will receive an email when it is processed.</div>')
					} else {
						alert(event.message);
					}
				}
			);
			return false;
		}

		function checkDetailsForm(event){
			var emptyFields = $('#details input').filter(function(){
				return $.trim(this.value) === '';
			});
			if (!emptyFields.length) {
				$('#submit').prop('disabled', false);
				setProgress(4);
			} else {
				$('#submit').prop('disabled', true);
				setProgress(3);
			}
		}

		function setProgress(step) {
			var stepMessages = ['Select dentist', 'Select date', 'Select hour', 'Enter details', 'Click Submit'];
			$('.progress-bar').css('width', step * 25 + '%').attr('aria-valuenow', step);
			$('#step').html('Step ' + (step + 1) + ': ' + stepMessages[step]);
			$('.panel').removeClass('panel-info');
			$('#panel' + step).addClass('panel-info');
		}
		
		$(document).ready(function() {
		
			if (sessionStorage.token == undefined) {
				sessionStorage.token = null;
			} else if (sessionStorage.token) {
				getReservedSlot(sessionStorage.token, function(result, event) {
					if(event.status){
						if (result) {
							selectedDentistID = result.Dentist__c;
							selectedTime = new Date(result.Date_and_time_start__c);
						}
					} else {
						alert(event.message);
					}
				});
			}
								
			$('#appDate').datepicker({
				dateFormat: 'yy-mm-dd',
				beforeShowDay: function(date) {
					for (var i = 0; i < availableDates.length; i++){
						if (date.toDateString() == availableDates[i].toDateString()) {
							return [true, ""];
						}
					}
					return [false, "Unavailable"];
				},
				firstDay: 1
			});
		
			$('#mainForm').submit(submitDetails);
			$('#details').find('input').prop('disabled', true);
			$('#submit').prop('disabled', true);
			$('#details input').keyup(checkDetailsForm);
			$('#details input').change(checkDetailsForm);
			$('#description').prop('disabled', true);

			$('#mainForm').hide();

			$('i.fa').hide();
			
			getDentists(function(result, event) {
				if(event.status){
					var inputNo = 0;
					$.each(result, function(key, value) {
						var option = $('<input>');
						$(option).attr('type', 'radio');
						$(option).attr('name', 'dentist');
						$(option).val(value.Id);
						var inputId = 'time' + inputNo++;
						$(option).attr('id', inputId);

						var label = $('<label>');
						$(label).attr('for', inputId);
						$(label).html(value.Name + ', ' + value.Speciality__c);
						
						$(label).prepend(option);
						var divRadio = $('<div class="radio"></div>');
						$(divRadio).append(label);
						$('#dentists').append(divRadio);
					});
					$('#mainForm').show();
					setProgress(0);
				} else {
					alert(event.message);
				}
			});
		});
		
		$(document).on('change', 'input[type=radio][name=dentist]', function() {

			$('#times').html('');
			$('#details').find('input').prop('disabled', true);
			$('#submit').prop('disabled', true);
			availableDates = [];
			$('#appDate').datepicker('setDate', null);
			$('#appDate').datepicker('refresh');
			$('#dentists').siblings('h4').children('i.fa').show();
			getDates($('input[type=radio][name=dentist]:checked').val(), function(result, event) {
				if(event.status){
					$.each(result, function(key, value) {					
						var d = new Date(value);
						availableDates.push(d);
					});
					$('#appDate').datepicker('refresh');
					setProgress(1);
					$('#dentists').siblings('h4').children('i.fa').hide();
				} else {
					alert(event.message);
				}
			});
		});
		
		$(document).on('change', '#appDate', function() {
			$('#submit').prop('disabled', true);
			$('#appDate').siblings('h4').children('i.fa').show();
			$('#times').html('');
			$('#details').find('input').prop('disabled', true);
			getTimes($('input[type=radio][name=dentist]:checked').val(), new Date($('#appDate').val()).toUTCString(), function(result, event) {
				if(event.status){
					var inputNo = 0;
					$.each(result, function(key, value) {
						var d = new Date(value);
						var option = $('<input>');
						$(option).attr('type', 'radio');
						$(option).attr('name', 'time');
						$(option).val(d.toUTCString());
						var inputId = 'time' + inputNo++;
						$(option).attr('id', inputId);

						var label = $('<label>');
						$(label).attr('for', inputId);
						$(label).html(d.toLocaleTimeString().substring(0,5));
						
						$(label).prepend(option);
						var divRadio = $('<div class="radio"></div>');
						$(divRadio).append(label);
						$('#times').append(divRadio);
					});
					setProgress(2);
					$('#appDate').siblings('h4').children('i.fa').hide();
				} else {
					alert(event.message);
				}
			});
		});
		
		$(document).on('change', 'input[type=radio][name=time]', function() {
			$('#times').siblings('h4').children('i.fa').show();
			reserveTimeSlot(sessionStorage.token, $('input[type=radio][name=dentist]:checked').val(), $('input[type=radio][name=time]:checked').val(), function(result, event) {
				if (event.status) {
					sessionStorage.setItem('token', result);
					$('#details').find('input').prop('disabled', false);
					setProgress(3);
					checkDetailsForm();
					$('#times').siblings('h4').children('i.fa').hide();
				} else {
					alert(event.message);
				}
			});
		});
		
		$(document).on('change', 'input[type=radio][name=type]', function() {
			if($('input[type=radio][name=type]:checked').val() == 'Treatment'){
				$('#description').prop('disabled', false);
			} else {
				$('#description').prop('disabled', true);
			}
		});
	</script>


	<div class="container">
		<form class="form" id="mainForm" role="form">
			<div class="row">
				<div class="jumbotron text-center">
					<h1>MentalDental</h1>
					<p>appointment registration</p>
				</div>
				<div class="well">
					<h2 id="step">Step 1: Select dentist</h2>
					<div class="progress">
						<div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="4">
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-xs-12 col-md-4">
					<div class="panel" id="panel0">
						<h4 class="panel-heading">Dentist<i class="fa fa-circle-o-notch fa-spin pull-right"></i></h4>
						<div id="dentists" class="panel-body">
						</div>
					</div>
					<div class="panel" id="panel1">
						<h4 class="panel-heading">Appointment date<i class="fa fa-circle-o-notch fa-spin pull-right"></i></h4>
						<div class="panel-body" id="appDate"></div>
					</div>
				</div>
				<div class="col-xs-12 col-md-4">
					<div class="panel" id="panel2">
						<h4 class="panel-heading">Appointment hour<i class="fa fa-circle-o-notch fa-spin pull-right"></i></h4>
						<div id="times" class="form-group panel-body">
						</div>
					</div>
				</div>
				<div class="col-xs-12 col-md-4">
					<div class="form-group panel" id="panel3">
						<h4 class="panel-heading">Details<i class="fa fa-circle-o-notch fa-spin pull-right"></i></h4>
						<div class="panel-body" id="details">
							<div id="types">	
								<label>Appointment type</label>
								<label class="radio control-label">
									<input type="radio" name="type" value="Consultation" checked="checked"></input>
									Consultation
								</label>
								<label class="radio control-label">
									<input type="radio" name="type" value="Treatment"></input>
									Treatment
								</label>
							</div>
							<span id="desc"><label for="description">Description</label><textarea name="description" class="form-control" id="description"></textarea><br/></span>
							<label for="firstname">First name</label><input type="text" name="firstname" class="form-control" id="firstname"></input>
							<label for="lastname">Last name</label><input type="text" name="lastname" class="form-control" id="lastname"></input>
							<label for="phone">Phone</label><input type="text" name="phone" class="form-control" id="phone"></input>
							<label for="email">Email</label><input type="email" name="email" class="form-control" id="email"></input>
							
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="form-group panel col-xs-12 col-sm-12 col-md-12 col-lg-12" id="panel4">
					<button type="submit" class="btn btn-primary btn-block" id="submit">Submit</button>
				</div>
			</div>
		</form>
	</div>
</apex:page>